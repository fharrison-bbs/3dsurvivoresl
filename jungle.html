<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jungle Adventure - Performance Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; position: fixed; overflow: hidden; touch-action: none; background: #112211; }
        #gameContainer { width: 100%; height: 100%; position: relative; }
        
        /* HUD */
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0, 20, 0, 0.8); padding: 10px; border-radius: 8px; font-family: sans-serif; font-size: 12px; z-index: 5; color: white; border: 1px solid #8dc464; pointer-events: none; }
        .bar-container { width: 100px; height: 8px; background: #000; margin: 4px 0; border-radius: 4px; overflow: hidden; }
        .bar { height: 100%; background: #8dc464; width: 100%; }

        /* Controls */
        #joystickZone { position: absolute; bottom: 0; left: 0; width: 50%; height: 50%; z-index: 10; }
        #thumb { width: 50px; height: 50px; background: #8dc464; border-radius: 50%; position: absolute; bottom: 60px; left: 60px; transform: translate(-50%, -50%); opacity: 0.6; }
        #shootBtn { position: absolute; bottom: 40px; right: 40px; width: 80px; height: 80px; background: #c8823c; border-radius: 50%; border: 4px solid #f4a460; z-index: 15; color: white; font-weight: bold; }
        
        #safeStatus { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); color: #8dc464; font-weight: bold; display: none; z-index: 5; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; align-items:center; justify-content:center; }
        .panel { background:#1e3c1e; padding:20px; border-radius:15px; border:2px solid #8dc464; width:80%; max-width:400px; text-align:center; color:white; }
        .ans { display:block; width:100%; padding:12px; margin:8px 0; background:#2a4a2a; border:1px solid #8dc464; color:white; border-radius:8px; }
    </style>
</head>
<body>
    <div id="gameContainer"></div>
    <div id="ui">
        <div>HP</div><div class="bar-container"><div id="hpBar" class="bar"></div></div>
        <div>SCORE: <span id="score">0</span></div>
        <div>AMMO: <span id="ammo">50</span></div>
    </div>
    <div id="safeStatus">ðŸŒ³ SAFE ZONE ðŸŒ³</div>
    <div id="joystickZone"><div id="thumb"></div></div>
    <button id="shootBtn">SHOOT</button>

    <div id="modal"><div class="panel"><h3 id="qText"></h3><div id="ansBox"></div></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js"></script>

    <script>
        window.addEventListener('load', () => {
            if (typeof THREE === 'undefined') {
                alert("Three.js failed to load. Please check your connection.");
                return;
            }

            const state = { hp: 100, ammo: 50, score: 0, paused: false, inSafe: false };
            const questions = [
                { q: "She ___ seen a tiger.", a: ["have", "has"], c: 1 },
                { q: "It is ___ hot to run.", a: ["too", "very"], c: 0 }
            ];

            // Setup
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x051105);
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 500);
            const renderer = new THREE.WebGLRenderer({ antialias: false }); // Antialias off for performance
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('gameContainer').appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambient);

            // Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshBasicMaterial({ color: 0x112211 }));
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);

            // Familiar Pet (Simplified)
            const pet = new THREE.Mesh(new THREE.SphereGeometry(0.15, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
            scene.add(pet);

            // Enemies
            const enemies = [];
            function spawn() {
                const en = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshBasicMaterial({ color: 0xff4444 }));
                en.position.set((Math.random()-0.5)*80, 0.6, (Math.random()-0.5)*80);
                scene.add(en);
                enemies.push(en);
            }
            for(let i=0; i<6; i++) spawn();

            // Controls
            const ctrl = { x: 0, y: 0, lookX: 0, lookY: 0, lastX: 0, lastY: 0 };
            const thumb = document.getElementById('thumb');

            document.getElementById('joystickZone').addEventListener('touchmove', e => {
                const t = e.touches[0];
                const dx = t.clientX - 60; const dy = t.clientY - (window.innerHeight - 60);
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                const ang = Math.atan2(dy, dx);
                ctrl.x = (Math.cos(ang)*dist)/40; ctrl.y = (Math.sin(ang)*dist)/40;
                thumb.style.left = (60 + Math.cos(ang)*dist) + 'px';
                thumb.style.top = (window.innerHeight - 60 + Math.sin(ang)*dist) + 'px';
            });

            document.getElementById('joystickZone').addEventListener('touchend', () => {
                ctrl.x = 0; ctrl.y = 0;
                thumb.style.left = '60px'; thumb.style.top = (window.innerHeight - 60) + 'px';
            });

            window.addEventListener('touchmove', e => {
                if(e.touches[0].clientX > window.innerWidth/2) {
                    const t = e.touches[0];
                    if(ctrl.lastX) {
                        ctrl.lookX = (t.clientX - ctrl.lastX) * 0.005;
                        ctrl.lookY = (t.clientY - ctrl.lastY) * 0.005;
                    }
                    ctrl.lastX = t.clientX; ctrl.lastY = t.clientY;
                }
            }, {passive: false});

            window.addEventListener('touchend', e => { if(e.touches.length === 0) { ctrl.lastX = 0; ctrl.lastY = 0; } });

            document.getElementById('shootBtn').addEventListener('touchstart', () => {
                if(state.ammo <= 0) return;
                state.ammo--;
                const b = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
                b.position.copy(camera.position);
                const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                scene.add(b);
                const moveB = setInterval(() => {
                    b.position.addScaledVector(dir, 0.7);
                    enemies.forEach((en, i) => {
                        if(b.position.distanceTo(en.position) < 1.5) {
                            en.position.set((Math.random()-0.5)*80, 0.6, (Math.random()-0.5)*80);
                            state.score += 10;
                            scene.remove(b); clearInterval(moveB);
                        }
                    });
                    if(b.position.length() > 100) { scene.remove(b); clearInterval(moveB); }
                }, 20);
            });

            function loop() {
                requestAnimationFrame(loop);
                if(state.paused) return;

                // Move
                const m = new THREE.Vector3(ctrl.x, 0, ctrl.y).applyAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y);
                camera.position.addScaledVector(m, 0.15);
                camera.rotation.y -= ctrl.lookX; camera.rotation.x -= ctrl.lookY;
                ctrl.lookX *= 0.8; ctrl.lookY *= 0.8;

                // Pet
                const pTgt = new THREE.Vector3().copy(camera.position).add(new THREE.Vector3(1, 0, 1.5).applyQuaternion(camera.quaternion));
                pet.position.lerp(pTgt, 0.1);

                // Safe Zone (Center)
                state.inSafe = camera.position.length() < 10;
                document.getElementById('safeStatus').style.display = state.inSafe ? 'block' : 'none';

                // Enemies
                enemies.forEach(en => {
                    if(!state.inSafe) {
                        const d = new THREE.Vector3().subVectors(camera.position, en.position).normalize();
                        en.position.addScaledVector(d, 0.04);
                    }
                    if(en.position.distanceTo(camera.position) < 1.2) state.hp -= 0.1;
                });

                // UI
                document.getElementById('hpBar').style.width = state.hp + '%';
                document.getElementById('score').textContent = state.score;
                document.getElementById('ammo').textContent = state.ammo;

                if(state.hp <= 0) { alert("Game Over"); location.reload(); }

                renderer.render(scene, camera);
            }
            loop();
        });
    </script>
</body>
</html>
