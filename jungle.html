<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ESL Jungle Adventure - Familiar Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; position: fixed; overflow: hidden; touch-action: none; background: #1a3a1a; }
        #gameContainer { width: 100%; height: 100%; position: relative; }
        
        /* HUD Style */
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(20, 40, 20, 0.9); padding: 12px; border-radius: 12px; font-size: 14px; z-index: 5; border: 1px solid #8dc464; pointer-events: none; color: white; min-width: 150px; }
        .bar-container { width: 100%; height: 10px; background: #000; border-radius: 5px; overflow: hidden; margin: 5px 0; border: 1px solid #444; }
        .bar { height: 100%; background: linear-gradient(90deg, #4caf50, #8dc464); width: 100%; transition: width 0.3s; }
        
        /* Mobile Controls */
        #joystickZone { position: absolute; bottom: 0; left: 0; width: 50%; height: 50%; z-index: 10; }
        #joystickContainer { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(141, 196, 100, 0.5); }
        .joystick-thumb { width: 50px; height: 50px; background: #8dc464; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px rgba(141, 196, 100, 0.8); }
        
        #lookZone { position: absolute; top: 0; right: 0; width: 50%; height: 70%; z-index: 9; }
        
        #shootButton { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; background: radial-gradient(circle, #c8823c, #a66a2e); border: 3px solid #f4a460; border-radius: 50%; z-index: 15; color: white; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px black; }
        
        /* Modals */
        #questionModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .question-panel { background: #1e3c1e; padding: 25px; border-radius: 20px; border: 3px solid #8dc464; width: 85%; max-width: 450px; text-align: center; color: white; }
        .answer-btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: #2a4a2a; border: 1px solid #8dc464; color: white; border-radius: 10px; font-size: 16px; cursor: pointer; }
        
        #safeRoomStatus { position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%); display: none; color: #8dc464; font-size: 24px; font-weight: bold; z-index: 20; text-shadow: 0 0 10px black; }
        #answerInSafeRoom { position: absolute; bottom: 150px; right: 40px; display: none; padding: 15px 25px; background: #dcb864; border: 2px solid #fff; border-radius: 30px; z-index: 25; font-weight: bold; color: #1a1a1a; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div id="gameContainer"></div>
    
    <div id="ui">
        <div>üåø HEALTH</div>
        <div class="bar-container"><div id="healthBar" class="bar"></div></div>
        <div style="margin-top:10px;">üéØ AMMO: <span id="ammo">50</span></div>
        <div>‚≠ê SCORE: <span id="score">0</span></div>
    </div>

    <div id="safeRoomStatus">üå≥ SAFE ZONE üå≥</div>
    <button id="answerInSafeRoom">üìù ANSWER QUESTION</button>

    <div id="joystickZone">
        <div id="joystickContainer">
            <div class="joystick-thumb"></div>
        </div>
    </div>
    
    <div id="lookZone"></div>
    <button id="shootButton">SHOOT</button>

    <div id="questionModal">
        <div class="question-panel">
            <h2 id="questionText"></h2>
            <div id="answerButtons"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js"></script>

    <script>
        // Use your "Research, Evaluate, Atomize" workflow
        // System Boundary: Ensure THREE is loaded before initializing game logic
        
        window.onload = () => {
            if (typeof THREE === 'undefined') {
                document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:50px;'>Error: Three.js failed to load. Please check your internet connection.</h1>";
                return;
            }

            // --- GAME STATE ---
            const state = { health: 100, ammo: 50, score: 0, paused: false, inSafeRoom: false };
            const questions = [
                { q: "The jungle is ___ beautiful.", a: ["very", "too", "enough"], c: 0 },
                { q: "This river is ___ deep to cross.", a: ["very", "too", "enough"], c: 1 },
                { q: "The vines are strong ___.", a: ["very", "too", "enough"], c: 2 }
            ];

            // --- SCENE SETUP ---
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a2a1a);
            scene.fog = new THREE.FogExp2(0x1a2a1a, 0.02);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 5);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('gameContainer').appendChild(renderer.domElement);

            // --- LIGHTING ---
            const ambient = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            // --- ENVIRONMENT ---
            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x1b301b });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Safe Zone Marker
            const safeGeo = new THREE.CircleGeometry(10, 32);
            const safeMat = new THREE.MeshBasicMaterial({ color: 0x8dc464, transparent: true, opacity: 0.3 });
            const safeZone = new THREE.Mesh(safeGeo, safeMat);
            safeZone.rotation.x = -Math.PI / 2;
            safeZone.position.set(0, 0.05, -30);
            scene.add(safeZone);

            // --- FAMILIAR PET ---
            const pet = new THREE.Group();
            const petBody = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 2 }));
            const petRing = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.02, 16, 32), new THREE.MeshStandardMaterial({ color: 0x00ffff }));
            petRing.rotation.x = Math.PI / 2;
            pet.add(petBody);
            pet.add(petRing);
            const petLight = new THREE.PointLight(0x00ffff, 1, 10);
            pet.add(petLight);
            scene.add(pet);

            // --- ENEMIES ---
            const enemies = [];
            function spawnEnemy() {
                const geo = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                const mat = new THREE.MeshStandardMaterial({ color: 0xff4444 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set((Math.random() - 0.5) * 60, 0.75, (Math.random() - 0.5) * 60);
                scene.add(mesh);
                enemies.push(mesh);
            }
            for(let i=0; i<5; i++) spawnEnemy();

            // --- CONTROLS ---
            const input = { x: 0, y: 0, lookX: 0, lookY: 0, lastX: 0, lastY: 0, touching: false };
            const thumb = document.querySelector('.joystick-thumb');

            document.getElementById('joystickZone').addEventListener('touchstart', e => { input.touching = true; });
            document.getElementById('joystickZone').addEventListener('touchmove', e => {
                const t = e.touches[0];
                const rect = document.getElementById('joystickContainer').getBoundingClientRect();
                const dx = t.clientX - (rect.left + rect.width/2);
                const dy = t.clientY - (rect.top + rect.height/2);
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                const angle = Math.atan2(dy, dx);
                input.x = (Math.cos(angle) * dist) / 40;
                input.y = (Math.sin(angle) * dist) / 40;
                thumb.style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
            });
            document.getElementById('joystickZone').addEventListener('touchend', () => { 
                input.x = 0; input.y = 0; input.touching = false; 
                thumb.style.transform = 'translate(-50%, -50%)';
            });

            document.getElementById('lookZone').addEventListener('touchstart', e => {
                input.lastX = e.touches[0].clientX;
                input.lastY = e.touches[0].clientY;
            });
            document.getElementById('lookZone').addEventListener('touchmove', e => {
                const t = e.touches[0];
                input.lookX = (t.clientX - input.lastX) * 0.005;
                input.lookY = (t.clientY - input.lastY) * 0.005;
                input.lastX = t.clientX;
                input.lastY = t.clientY;
            });

            document.getElementById('shootButton').addEventListener('click', () => {
                if(state.ammo > 0) {
                    state.ammo--;
                    document.getElementById('ammo').textContent = state.ammo;
                    // Bullet logic simplified for performance
                    const bGeo = new THREE.SphereGeometry(0.2);
                    const bMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                    const bullet = new THREE.Mesh(bGeo, bMat);
                    bullet.position.copy(camera.position);
                    const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                    scene.add(bullet);
                    const bInt = setInterval(() => {
                        bullet.position.addScaledVector(dir, 0.8);
                        enemies.forEach((en, i) => {
                            if(bullet.position.distanceTo(en.position) < 1.5) {
                                scene.remove(en); enemies.splice(i,1); scene.remove(bullet);
                                state.score += 10; document.getElementById('score').textContent = state.score;
                                spawnEnemy(); clearInterval(bInt);
                            }
                        });
                        if(bullet.position.length() > 100) { scene.remove(bullet); clearInterval(bInt); }
                    }, 20);
                }
            });

            // --- GRAMMAR UI ---
            function openQuestion() {
                state.paused = true;
                const q = questions[Math.floor(Math.random() * questions.length)];
                document.getElementById('questionText').textContent = q.q;
                const btnBox = document.getElementById('answerButtons');
                btnBox.innerHTML = '';
                q.a.forEach((ans, i) => {
                    const b = document.createElement('button');
                    b.className = 'answer-btn';
                    b.textContent = ans;
                    b.onclick = () => {
                        if(i === q.c) { state.score += 50; state.health = Math.min(100, state.health + 20); }
                        else { state.health -= 10; }
                        document.getElementById('questionModal').style.display = 'none';
                        state.paused = false;
                    };
                    btnBox.appendChild(b);
                });
                document.getElementById('questionModal').style.display = 'flex';
            }
            document.getElementById('answerInSafeRoom').onclick = openQuestion;

            // --- MAIN LOOP ---
            let time = 0;
            function animate() {
                requestAnimationFrame(animate);
                if(state.paused) return;

                // Movement
                const moveVec = new THREE.Vector3(input.x, 0, input.y).applyAxisAngle(new THREE.Vector3(0,1,0), camera.rotation.y);
                camera.position.addScaledVector(moveVec, 0.2);
                
                // Look
                camera.rotation.y -= input.lookX;
                camera.rotation.x -= input.lookY;
                camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
                input.lookX *= 0.9; input.lookY *= 0.9;

                // Pet Follow Logic
                time += 0.05;
                const petTarget = new THREE.Vector3().copy(camera.position);
                const offset = new THREE.Vector3(1.5, Math.sin(time)*0.2 + 0.5, 2).applyQuaternion(camera.quaternion);
                petTarget.add(offset);
                pet.position.lerp(petTarget, 0.1);
                petRing.rotation.z += 0.05;

                // Safe Room Boundary Check
                const distToSafe = camera.position.distanceTo(new THREE.Vector3(0, 1.6, -30));
                state.inSafeRoom = distToSafe < 10;
                document.getElementById('safeRoomStatus').style.display = state.inSafeRoom ? 'block' : 'none';
                document.getElementById('answerInSafeRoom').style.display = state.inSafeRoom ? 'block' : 'none';

                // Enemy AI
                enemies.forEach(en => {
                    const eDir = new THREE.Vector3().subVectors(camera.position, en.position).normalize();
                    if(!state.inSafeRoom) en.position.addScaledVector(eDir, 0.05);
                    if(en.position.distanceTo(camera.position) < 1.5) state.health -= 0.1;
                });

                // HUD
                document.getElementById('healthBar').style.width = state.health + '%';
                if(state.health <= 0) {
                    alert("Game Over! Score: " + state.score);
                    location.reload();
                }

                renderer.render(scene, camera);
            }
            animate();

            window.onresize = () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            };
        };
    </script>
</body>
</html>
