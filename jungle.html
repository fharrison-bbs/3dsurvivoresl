<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ESL Jungle Adventure - Grammar Quest</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { width: 100%; height: 100%; position: fixed; overflow: hidden; touch-action: none; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a3a1a; color: #fff; }
        #gameContainer { width: 100%; height: 100%; position: relative; }
        
        /* UI and HUD */
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(20, 40, 20, 0.9); padding: 12px; border-radius: 12px; font-size: 11px; z-index: 5; border: 1px solid #8dc464; pointer-events: none; }
        .bar-container { width: 100%; height: 8px; background: #000; border-radius: 4px; overflow: hidden; margin: 4px 0; }
        .bar { height: 100%; background: #8dc464; transition: width 0.2s; }
        
        /* Controls */
        #joystickZone { position: absolute; bottom: 0; left: 0; width: 50%; height: 50%; z-index: 10; }
        #joystickContainer { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; }
        .joystick-base { width: 100%; height: 100%; background: rgba(100, 200, 100, 0.2); border: 3px solid #8dc464; border-radius: 50%; position: relative; }
        .joystick-thumb { width: 60px; height: 60px; background: #8dc464; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #lookZone { position: absolute; top: 0; right: 0; width: 50%; height: 70%; z-index: 9; }
        #shootButton { position: absolute; bottom: 30px; right: 30px; width: 100px; height: 100px; background: #c8823c; border: 4px solid #f4a460; border-radius: 50%; z-index: 15; color: white; font-weight: bold; }
        
        /* Modals */
        #questionModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .question-panel { background: #1e3c1e; padding: 20px; border-radius: 20px; border: 3px solid #8dc464; width: 90%; max-width: 400px; text-align: center; }
        .answer-btn { display: block; width: 100%; padding: 12px; margin: 8px 0; background: #2a4a2a; border: 1px solid #8dc464; color: white; border-radius: 8px; }
        #safeRoomStatus { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; color: #8dc464; font-weight: bold; z-index: 20; }
        #answerInSafeRoom { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); display: none; padding: 15px; background: #dcb864; border: none; border-radius: 10px; z-index: 25; }
        #gameMessage { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 101; align-items: center; justify-content: center; }
        #minimap { position: absolute; bottom: 10px; left: 10px; width: 90px; height: 90px; border: 2px solid #8dc464; background: rgba(0,0,0,0.5); z-index: 6; }
    </style>
</head>
<body>
    <div id="gameContainer"></div>
    <div id="ui">
        <div>üåø HEALTH: <span id="health">100</span></div>
        <div class="bar-container"><div id="healthBar" class="bar"></div></div>
        <div style="margin-top:5px;">üéØ AMMO: <span id="ammo">50</span></div>
        <div style="margin-top:5px;">‚≠ê SCORE: <span id="score">0</span></div>
        <div style="margin-top:5px;">üìä LEVEL: <span id="level">1</span></div>
    </div>

    <div id="joystickZone"><div id="joystickContainer"><div class="joystick-base"><div class="joystick-thumb"></div></div></div></div>
    <div id="lookZone"></div>
    <button id="shootButton">SHOOT</button>
    <div id="minimap"><canvas id="minimapCanvas" width="90" height="90"></canvas></div>
    <div id="safeRoomStatus">üå≥ SAFE ZONE üå≥</div>
    <button id="answerInSafeRoom">üìù ANSWER QUESTION</button>

    <div id="questionModal"><div class="question-panel"><div id="questionText"></div><div id="answerButtons"></div></div></div>
    <div id="gameMessage"><div id="gameOverText"></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js"></script>

    <script>
        // WAIT FOR DOM AND THREE.JS
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof THREE === 'undefined') {
                console.error("Three.js failed to load.");
                return;
            }

            // GAME STATE
            const gameState = { health: 100, ammo: 50, score: 0, level: 1, gameOver: false, paused: false, inSafeRoom: false };
            const questions = [
                { question: "She ___ visited this jungle three times.", answers: ["have", "has", "had"], correct: 1 },
                { question: "This tree is ___ tall to climb.", answers: ["very", "too", "enough"], correct: 1 },
                { question: "The monkeys are ___ playful.", answers: ["extremely", "too", "much"], correct: 0 }
            ];

            const ARENA_SIZE = 80;
            const SAFE_ROOM = { x: 0, z: 60, width: 16, depth: 16 };

            // SCENE SETUP
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a3a2a);
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('gameContainer').appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 5);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));

            // ENVIRONMENT
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(ARENA_SIZE * 2, ARENA_SIZE * 2), new THREE.MeshStandardMaterial({ color: 0x228b22 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // FAMILIAR PET SYSTEM
            const pets = [];
            function createPet() {
                const petGroup = new THREE.Group();
                const core = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 2 }));
                const ring = new THREE.Mesh(new THREE.TorusGeometry(0.35, 0.02, 16, 32), new THREE.MeshStandardMaterial({ color: 0x00ffff }));
                ring.rotation.x = Math.PI / 2;
                petGroup.add(core);
                petGroup.add(ring);
                const pLight = new THREE.PointLight(0x00ffff, 1, 5);
                petGroup.add(pLight);
                scene.add(petGroup);
                pets.push({ mesh: petGroup, ring: ring, floatY: 0 });
            }

            // ENEMIES
            const enemies = [];
            function spawnEnemy() {
                const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                const enemy = new THREE.Mesh(geometry, material);
                enemy.position.set((Math.random() - 0.5) * 50, 0.75, (Math.random() - 0.5) * 50);
                scene.add(enemy);
                enemies.push(enemy);
            }

            // CONTROLS
            const touchState = { joystick: { currentX: 0, currentY: 0 }, look: { deltaX: 0, deltaY: 0, lastX: 0, lastY: 0 } };
            
            document.getElementById('joystickZone').addEventListener('touchmove', e => {
                const t = e.touches[0];
                const rect = document.getElementById('joystickContainer').getBoundingClientRect();
                const dx = t.clientX - (rect.left + 70);
                const dy = t.clientY - (rect.top + 70);
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                const angle = Math.atan2(dy, dx);
                touchState.joystick.currentX = (Math.cos(angle) * dist) / 40;
                touchState.joystick.currentY = (Math.sin(angle) * dist) / 40;
                document.querySelector('.joystick-thumb').style.transform = `translate(calc(-50% + ${Math.cos(angle)*dist}px), calc(-50% + ${Math.sin(angle)*dist}px))`;
            });

            document.getElementById('joystickZone').addEventListener('touchend', () => {
                touchState.joystick.currentX = 0; touchState.joystick.currentY = 0;
                document.querySelector('.joystick-thumb').style.transform = 'translate(-50%, -50%)';
            });

            document.getElementById('shootButton').addEventListener('touchstart', () => {
                if (gameState.ammo > 0) {
                    gameState.ammo--;
                    const bullet = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
                    bullet.position.copy(camera.position);
                    const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                    scene.add(bullet);
                    // Simple bullet logic
                    const bInterval = setInterval(() => {
                        bullet.position.addScaledVector(dir, 0.5);
                        enemies.forEach((en, i) => {
                            if (bullet.position.distanceTo(en.position) < 1.5) {
                                scene.remove(en); enemies.splice(i, 1); scene.remove(bullet);
                                gameState.score += 10; clearInterval(bInterval);
                            }
                        });
                        if (bullet.position.length() > 200) { scene.remove(bullet); clearInterval(bInterval); }
                    }, 20);
                }
            });

            function showQuestion() {
                gameState.paused = true;
                const q = questions[Math.floor(Math.random() * questions.length)];
                document.getElementById('questionText').textContent = q.question;
                const container = document.getElementById('answerButtons');
                container.innerHTML = '';
                q.answers.forEach((ans, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'answer-btn'; btn.textContent = ans;
                    btn.onclick = () => {
                        if (i === q.correct) { gameState.score += 50; gameState.health = Math.min(100, gameState.health + 10); }
                        document.getElementById('questionModal').style.display = 'none';
                        gameState.paused = false;
                    };
                    container.appendChild(btn);
                });
                document.getElementById('questionModal').style.display = 'flex';
            }

            document.getElementById('answerInSafeRoom').addEventListener('touchstart', showQuestion);

            // ANIMATION LOOP
            function animate() {
                requestAnimationFrame(animate);
                if (gameState.paused || gameState.gameOver) return;

                // Move Player
                const move = new THREE.Vector3(touchState.joystick.currentX, 0, touchState.joystick.currentY).applyAxisAngle(new THREE.Vector3(0, 1, 0), camera.rotation.y);
                camera.position.addScaledVector(move, 0.15);

                // Update Pet
                pets.forEach(p => {
                    const target = new THREE.Vector3().copy(camera.position);
                    const offset = new THREE.Vector3(1.2, 0.5, 1.5).applyQuaternion(camera.quaternion);
                    target.add(offset);
                    p.mesh.position.lerp(target, 0.05);
                    p.floatY += 0.05;
                    p.mesh.position.y += Math.sin(p.floatY) * 0.005;
                    p.ring.rotation.z += 0.02;
                });

                // Check Safe Room
                const inRoom = Math.abs(camera.position.x - SAFE_ROOM.x) < 8 && Math.abs(camera.position.z - SAFE_ROOM.z) < 8;
                document.getElementById('safeRoomStatus').style.display = inRoom ? 'block' : 'none';
                document.getElementById('answerInSafeRoom').style.display = inRoom ? 'block' : 'none';

                // HUD Update
                document.getElementById('health').textContent = Math.ceil(gameState.health);
                document.getElementById('healthBar').style.width = gameState.health + '%';
                document.getElementById('ammo').textContent = gameState.ammo;
                document.getElementById('score').textContent = gameState.score;

                if (enemies.length < 3) spawnEnemy();

                renderer.render(scene, camera);
            }

            createPet();
            animate();
        });
    </script>
</body>
</html>
